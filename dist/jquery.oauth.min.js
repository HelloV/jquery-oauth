!function(t,e){"function"==typeof define&&define.amd?define(["jquery","store"],e):"object"==typeof exports?module.exports=e(require("jquery"),require("store")):t.jqOAuth=e(t.jQuery,t.store)}(this,function(t,e){var o=function(e){this.options={},this.data={},this.intercept=!1,this.refreshing=!1,this.buffer=[],this.currentRequests=[],this._resetOptions(),this._setupInterceptor(),t.extend(this.options,e),this._hasStoredData()?(this._getStoredData(),this.hasAccessToken()&&this.login(this.data.accessToken)):(this._resetData(),this._updateStorage()),null!==e.csrfToken&&this._setCsrfHeader()};return o.prototype.getAccessToken=function(){return this.data.accessToken},o.prototype.hasAccessToken=function(){return null!==this.data.accessToken},o.prototype.logout=function(){this._resetData(),this._updateStorage(),this._deactivateInterceptor(),this._removeAjaxHeader("Authorization"),this._fireEvent("logout")},o.prototype.login=function(t){this.setAccessToken(t),this._activateInterceptor(),this._fireEvent("login")},o.prototype.setAccessToken=function(t){this.data.accessToken=t,this._setAuthorizationHeader(),this._updateStorage()},o.prototype.setCsrfToken=function(t){this.options.csrfToken=t,this._setCsrfHeader()},o.prototype._activateInterceptor=function(){this.intercept=!0},o.prototype._addToBuffer=function(t,e){this.buffer.push({deferred:e,settings:t})},o.prototype._clearBuffer=function(){this.buffer=[]},o.prototype._deactivateInterceptor=function(){this.intercept=!1},o.prototype._fireBuffer=function(){var e,o=this,r=[];for(var s in this.buffer)e=this.buffer[s].deferred,this.buffer[s].settings.refreshRetry=!0,this.buffer[s].settings.headers.Authorization=t.ajaxSettings.headers.Authorization,r.push(t.ajax(this.buffer[s].settings).then(e.resolve,e.reject));this._clearBuffer(),t.when.apply(t,r).done(function(){o._setRefreshingFlag(!1)}).fail(function(){o._setRefreshingFlag(!1),this.logout()})},o.prototype._fireEvent=function(t){return this._hasEvent(t)?this.options.events[t]():void 0},o.prototype._getStoredData=function(){t.extend(this.data,e.get(this.options.tokenName))},o.prototype._hasEvent=function(t){return void 0!==this.options.events[t]&&"function"==typeof this.options.events[t]},o.prototype._hasStoredData=function(){return void 0!==e.get(this.options.tokenName)},o.prototype._isAjaxHeadersInitialized=function(){return void 0!==t.ajaxSettings.headers},o.prototype._removeAjaxHeader=function(e){return this._isAjaxHeadersInitialized()?void(t.ajaxSettings.headers[e]=void 0):!0},o.prototype._removeAllAjaxHeaders=function(){this._removeAjaxHeader("Authorization"),this._removeAjaxHeader("X-CSRF-Token")},o.prototype._resetData=function(){this.data={accessToken:null}},o.prototype._resetOptions=function(){this.options={bufferInterval:25,bufferWaitLimit:500,csrfToken:null,events:{},tokenName:"jquery.oauth"},this._removeAllAjaxHeaders()},o.prototype._setAjaxHeader=function(e,o){this._isAjaxHeadersInitialized()||(t.ajaxSettings.headers={}),t.ajaxSettings.headers[e]=o},o.prototype._setAuthorizationHeader=function(){this._setAjaxHeader("Authorization","Bearer "+this.data.accessToken)},o.prototype._setCsrfHeader=function(){this._setAjaxHeader("X-CSRF-Token",this.options.csrfToken)},o.prototype._setRefreshingFlag=function(t){this.refreshing=t},o.prototype._setupInterceptor=function(){var e=this;t.ajaxPrefilter(function(o,r,s){if(o.refreshRetry!==!0){var i=t.Deferred();return e.currentRequests.push(o.url),s.always(function(){e.currentRequests.splice(t.inArray(o.url,e.currentRequests),1)}),s.done(i.resolve),s.fail(function(){var t=Array.prototype.slice.call(arguments);e.intercept&&401===s.status&&e._hasEvent("tokenExpiration")?(e._addToBuffer(o,i),e.refreshing||(e._setRefreshingFlag(!0),e._fireEvent("tokenExpiration").success(function(){console.log("REFRESH SUCCESS");var t=0;e.interval=setInterval(function(){t+=e.options.bufferInterval,(0===e.currentRequests.length||t>=e.options.bufferWaitLimit)&&(clearInterval(e.interval),e._fireBuffer())},e.options.bufferInterval)}).fail(function(){console.log("REFRESH FAIL"),e.logout()}))):i.rejectWith(s,t)}),i.promise(s)}})},o.prototype._updateStorage=function(){e.set(this.options.tokenName,this.data)},o});